# SovereignCore Deployment Workflow
# Separate deployment workflow with manual triggers

name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version/tag to deploy (leave empty for latest)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ github.event.inputs.environment == 'production' && 'https://sovereigncore.com' || 'https://staging.sovereigncore.com' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment version
        id: version
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            echo "version=latest" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}

      - name: Deploy to ${{ github.event.inputs.environment }}
        run: |
          echo "Deploying version ${{ steps.version.outputs.version }} to ${{ github.event.inputs.environment }}"
          
          # Example deployment commands (customize based on your infrastructure)
          # For Docker Compose:
          # docker-compose -f docker-compose.${{ github.event.inputs.environment }}.yml pull
          # docker-compose -f docker-compose.${{ github.event.inputs.environment }}.yml up -d
          
          # For Kubernetes:
          # kubectl set image deployment/sovereigncore sovereigncore=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} -n ${{ github.event.inputs.environment }}
          # kubectl rollout status deployment/sovereigncore -n ${{ github.event.inputs.environment }}
          
          # For SSH deployment:
          # ssh user@server "cd /app && docker-compose pull && docker-compose up -d"

      - name: Health check
        run: |
          echo "Waiting for service to be healthy..."
          sleep 30
          
          # Add health check based on your environment
          # curl -f https://${{ github.event.inputs.environment }}.sovereigncore.com/health

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add smoke test commands

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, initiating rollback..."
          # Add rollback commands

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to ${{ github.event.inputs.environment }} successful"
          else
            echo "❌ Deployment to ${{ github.event.inputs.environment }} failed"
          fi
          # Add notification logic (Slack, Discord, email, etc.)
